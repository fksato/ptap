<!doctype html>

<head>
<meta name="mobile-web-app-capable" content="yes"> <!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>


<script>
// ******* The experimenter fills out GAME_PACKAGE AND ENVIRONMENT ********* 
async function setupSession(){

   IMAGEBAGS = {"stimulus_objectome_flute":["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_flute_e0aed0e2c3f0c3cb7a7e235bd931f193a536391d_ty-0.85987_tz-0.38018_rxy-36.131_rxz152.6439_ryz28.9932_s1.4314.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_flute_2012a31313faa422b2623460d0c33a9f5eb3b238_ty-0.33547_tz-0.0026731_rxy-38.2159_rxz-115.311_ryz90.0954_s1.3508.png"], 
        "token_objectome_flute": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_flute.png"], 
        "stimulus_objectome_dog": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_dog_e1ed016de5e47e8a6567123ce134d72b7187db73_ty0.43294_tz-0.29943_rxy-112.6794_rxz75.5665_ryz127.211_s1.6328.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_dog_28ebb7db56691da21fa6d640f5ef719f916cb7ff_ty-0.48998_tz-0.20078_rxy-84.7937_rxz-117.8076_ryz175.5429_s1.3151.png"], 
        "token_objectome_dog": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_dog.png"], 
        "token_objectome_pineapple": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_pineapple.png"],
        "stimulus_objectome_pineapple": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_pineapple_5946318bc2cdd1947534ae15d43aa7a0d820506e_ty-0.64759_tz0.33642_rxy-5.6836_rxz-71.4586_ryz62.4466_s1.169.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_pineapple_c50790daa826f1d3fbed5580820c6c91fdded273_ty-0.57074_tz0.84081_rxy-157.3224_rxz64.5421_ryz167.7568_s0.86084.png"]
        }

  GAME = {'gameID':'example_inlab_MTS',
          "periodicRewardIntervalMsec":60000,
          "periodicRewardAmount":1,
          "bonusUSDPerCorrect":0, 
          "onFinish":"continue", // terminate, continue
          "randomSeed":'none',
  }

  TASK_SEQUENCE = [{
                  "taskType":"MTS", 
                  "sampleBagNames":['stimulus_objectome_pineapple', 'stimulus_objectome_flute', 
                  'stimulus_objectome_dog'], 
                  "fixationXCentroid":0.5,
                  "fixationYCentroid":0.8,
                  "fixationDiameterDegrees":3,
                  "sampleXCentroid":0.5,
                  "sampleYCentroid":0.5,
                  "sampleDiameterDegrees":8,
                  "actionXCentroid":[0.2, 0.8], 
                  "actionYCentroid":[0.8, 0.8],
                  "actionDiameterDegrees":[6, 6],
                  "choiceXCentroid":[0.2, 0.8],
                  "choiceYCentroid":[0.8, 0.8],
                  "choiceDiameterDegrees":[6, 6],
                  "choiceMap":{"stimulus_objectome_flute":"token_objectome_flute", 
                  "stimulus_objectome_pineapple":"token_objectome_pineapple", 
                  'stimulus_objectome_dog':"token_objectome_dog"}, 
                  "sampleOnMsec":200, 
                  "sampleOffMsec":0,
                  "choiceTimeLimitMsec":5000,
                  "punishTimeOutMsec":100,
                  "punishStreakTimeOutMultiplier":1,
                  "rewardTimeOutMsec":150,
                  "probabilityRepeatWhenWrong":0,
                  "averageReturnCriterion":0.8, 
                  "minTrialsCriterion":5,
                  }]

  ENVIRONMENT = {
                    'playspace_degreesVisualAngle':30,
                    'playspace_verticalOffsetInches':0, 
                    'playspace_viewingDistanceInches':8, 
                    'screen_virtualPixelsPerInch':143.755902965,
                    'primary_reinforcer_type':'juice', 
                    'action_event_type':['mouseup', 'touchstart', 'touchmove'],
                    'rigEnvironment':'monkeybox', // or monkeybox
                }  

  try{
    GAME_PACKAGE = {'GAME':GAME, 'TASK_SEQUENCE':TASK_SEQUENCE, 'IMAGEBAGS':IMAGEBAGS}
  }
  catch(error){
    console.log(error)
    GAME_PACKAGE = undefined
  }

  try{
    ENVIRONMENT = ENVIRONMENT    
  }
  catch(error){
    console.log(error)
    ENVIRONMENT = undefined    
  }
  
  try{
    // Not necessary to fill out for mechanical turk; in that case the workerId is extracted from the URL suffix. 
    // Fill in for upstairs task; e.g. 'Zico'
    agentID = 'Inlab_MatchToSample_Worker'
  }
  catch(error){
    console.log(error)
    agentID = 'unknown_agent_'+Math.round(window.performance.timing.navigationStart)
  }

  var localSavePackage = {'GAME_PACKAGE':GAME_PACKAGE, 'ENVIRONMENT':ENVIRONMENT, 'agentID':agentID}
  await concludeLandingPage(localSavePackage)
}

</script>

<script>
// ******** Util functions ********
async function concludeLandingPage(localSavePackage){
    
    GAME_PACKAGE = localSavePackage['GAME_PACKAGE']
    ENVIRONMENT = localSavePackage['ENVIRONMENT']

    console.log('landing page url', window.location.href)

    await localStorage.setItem("GAME_PACKAGE", btoa(JSON.stringify(GAME_PACKAGE)))
    await localStorage.setItem("ENVIRONMENT", btoa(JSON.stringify(ENVIRONMENT)))
    await localStorage.setItem('LANDING_PAGE_URL', btoa(window.location.href))
    await localStorage.setItem('agentID', btoa(localSavePackage['agentID']))

    console.log('All items stored. Redirecting...')
    await new Promise(resolve => setTimeout(resolve, 1000));
    go_to_main_page()
}

function go_to_main_page(){
  var currentURL = window.location.href 
    if(currentURL.indexOf('localhost')!=-1){
        window.location.href = '/public/mkturk.html?randomid=' +Math.random()
    }
    else{
        window.location.href = "https://s3.amazonaws.com/ptapscratch/public/mkturk.html?randomid="+Math.random()
    }
}

async function get_ip_address(){
      // need to do here or can do in main?
      
      var resolveFunc
      var rejectFunc
      var p = new Promise(function(resolve, reject){
          resolveFunc = resolve
          rejectFunc = reject
      })

      var xhttp = new XMLHttpRequest(); 


      try{
          xhttp.onreadystatechange = function(){
              if (this.readyState == 4 && this.status == 200){
                  resolveFunc(this.responseText)
              }
          }
      }
      catch(error){
          console.log(error)
      }
      
      xhttp.open("GET", "https://api.ipify.org?format=json", true);

      xhttp.send();
      var s = await p
      s = JSON.parse(s)

      return s['ip']       
}

</script>


<script>
(async function(){
    await setupSession();
}
)()
</script>

</head>

<body>
    Loading HIT...
</body>
</html>
<!doctype html>

<head>



<script>
// https://stackoverflow.com/questions/17309199/how-to-send-variables-from-one-file-to-another-in-javascript

// https://stackoverflow.com/questions/5411538/redirect-from-an-html-page

function extractURLdata(){

   // Extract workerId
    var name = 'workerId'
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(window.location.href) || ["", "workerId_notFound"] 
    workerId = results[1];

    // Extract assignmentId
    name = 'assignmentId'
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  console.log(results)
  var results = regex.exec(window.location.href) || ["", ""] 
  assignmentId = results[1];

  // Extract hitId
  name = 'hitId'
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  console.log(results)
  var results = regex.exec(window.location.href) || ["", "hitId_not_found"] 
  hitId = results[1];


    var SUBJECT = {
    "SubjectID":'MechanicalTurker_'+workerId,
    "Species": "human",
    "assignmentId": assignmentId,
    'workerId': workerId,
    'hitId':hitId
    }
    return SUBJECT
}

async function getIP(){
  
  var resolveFunc
  var rejectFunc
  var p = new Promise(function(resolve, reject){
      resolveFunc = resolve
      rejectFunc = reject
  })

  var xhttp = new XMLHttpRequest(); 


  try{
      xhttp.onreadystatechange = function(){
          if (this.readyState == 4 && this.status == 200){
              resolveFunc(this.responseText)
          }
      }
  }
  catch(error){
      console.log(error)
  }
  
  xhttp.open("GET", "https://api.ipify.org?format=json", true);
  console.log("xhttp", xhttp)

  xhttp.send();
  var s = await p
  s = JSON.parse(s)

  return s['ip']
        
}


async function saveData() {
  console.log('hello')
  // Store url to experiment file .txt

  var EXPERIMENT = {
    "ImageBags": {
    "stimulus_objectome_flute":["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_flute_e0aed0e2c3f0c3cb7a7e235bd931f193a536391d_ty-0.85987_tz-0.38018_rxy-36.131_rxz152.6439_ryz28.9932_s1.4314.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_flute_2012a31313faa422b2623460d0c33a9f5eb3b238_ty-0.33547_tz-0.0026731_rxy-38.2159_rxz-115.311_ryz90.0954_s1.3508.png"], 
    "token_objectome_flute": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_flute.png"], 
    "stimulus_objectome_dog": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_dog_e1ed016de5e47e8a6567123ce134d72b7187db73_ty0.43294_tz-0.29943_rxy-112.6794_rxz75.5665_ryz127.211_s1.6328.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_dog_28ebb7db56691da21fa6d640f5ef719f916cb7ff_ty-0.48998_tz-0.20078_rxy-84.7937_rxz-117.8076_ryz175.5429_s1.3151.png"], 
    "token_objectome_dog": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_dog.png"], 
    "token_objectome_pineapple": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome_tokens/images/objectomeTokens_objectome_pineapple.png"],
    "stimulus_objectome_pineapple": ["https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_pineapple_5946318bc2cdd1947534ae15d43aa7a0d820506e_ty-0.64759_tz0.33642_rxy-5.6836_rxz-71.4586_ryz62.4466_s1.169.png", "https://s3.amazonaws.com/milresources/Images/MonkeyTurkSets/objectome/images/objectome_pineapple_c50790daa826f1d3fbed5580820c6c91fdded273_ty-0.57074_tz0.84081_rxy-157.3224_rxz64.5421_ryz167.7568_s0.86084.png"]
  }, 

    "Game":[
    {"initial_TaskStream_trial_number": 0, 
    "Task": "MTS", 
    "SampleGridIndex": 4, 
    "MinTrialsCriterion": 0, 
    "TestImageBagNames": ["token_objectome_flute", "token_objectome_pineapple", "token_objectome_dog"], 
    "SampleImageBagNames": ["stimulus_objectome_flute", "stimulus_objectome_pineapple", "stimulus_objectome_dog"], 
    "NGridPoints": 3, 
    "PunishTimeOut": 1000, 
    "KeepSampleOn": 0, 
    "t_SampleON": 800, 
    "probability_repeat_trial_if_wrong": 0, 
    "ObjectGridMapping": [2, 8],
     "t_SampleOFF": 0, 
     "AverageReturnCriterion": 0, 
     "Nway": 2, 
     "StageNickname": "example_MTS_stage0", 
     "samplingRNGseed": 0, 
     "ChoiceTimeOut": 5000}
    ]
  }
  EXPERIMENT = JSON.stringify(EXPERIMENT)


  var data = btoa(EXPERIMENT);
  await localStorage.setItem('Experiment_string', data);

  // Store mechanical turk settings
  var mechanical_turk_data = '{"sandbox": true, "bonus_usd_per_correct": 0.0005, "MAX_SESSION_TRIALS_MECHANICALTURK": 700, "MinimumTrialsForCashIn": 350, "on_finish": "loop"}'
  mechanical_turk_data = btoa(mechanical_turk_data)
  await localStorage.setItem('HIT_settings_string', mechanical_turk_data)

  console.log('Landing page href:', window.location.href)

  // Store information sent by Amazon via the current url 
  SUBJECT = extractURLdata()
  console.log('Landing screen SUBJECT', SUBJECT)
  await localStorage.setItem('SubjectSettings_string', btoa(JSON.stringify(SUBJECT)))

  // Extract ip address
  var IP = await getIP()
  console.log("landing screen public IP", IP)
  await localStorage.setItem("IP_address", btoa(IP))

    await localStorage.setItem("setupFunction", btoa("setupMechanicalTurkTask()"))
}


(async function(){
  await saveData()
  window.location.href = "../public/mkturk.html"

})()


</script>


</head>

<body>
Loading HIT...
</body>
</html>
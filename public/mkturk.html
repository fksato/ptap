<!doctype html>

<head>
<link rel="shortcut icon" type="image/png" href="favicon.png"/>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<link rel="stylesheet" type="text/css" href="mkturk_style.css">

<form style="display: none;" id="MechanicalTurk_SubmissionForm" action="https://www.mturk.com/mturk/externalSubmit" method="post">
  <input type="text" name="submission_data" id="submission_data" value="">
  <input type="text" name="assignmentId" id="assignmentId" value="">
  <input type="text" name="hitId" id="hitId" value="">
</form>

<meta name="mobile-web-app-capable" content="yes"> 
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> 
<link rel="manifest" href="mkturkmanifest.json">
</head>

<body style="overflow-y: hidden; overflow-x:hidden; background-color:#494c51">

<button id="connectble" name="connectble" >Connect to Bluetooth juicer</button>
<button id="noble" name="noble">No Bluetooth juicer</button>


<div id="HUD">
    <div id="LoadStatusTextBox">Welcome! Loading assets...</div>
    <div id="MechanicalTurk_ProgressBar">
        <div id="MechanicalTurk_TrialBar"></div>
    </div>

    <div id='bonus_counter'>Bonus cents: 0.000</div>


    <div id="DebugMessageTextBox">Welcome...</div>

    <div id="SessionTextBox"><b>Subject:</b> <br><b>Experiment:</b></div>

    <div id="PreviewModeSplash"><p style="color:red; font-size:14px; font-weight:bold; text-align:center">PREVIEW MODE</p>Please use <b>Google Chrome</b> and turn your <b>sound on</b>. For the HIT to load properly, <b>cookies</b> must be enabled.   
    </div>
</div>




<div id="MechanicalTurkInstructionsSplash">
  <div id='InstructionSplashText'> Loading instructions... </div>
  <button onclick="toggleElement(0, 'MechanicalTurkInstructionsSplash')" id='CloseInstructionsButton' disabled> Loading... </button>
</div>

<div id="MechanicalTurkCursorDeviceSelectionScreen">

  <input type="image" class='DeviceButton' id='MouseImage'  style="" id="MouseImage" src="tutorial_images/mouse.png " alt="Mouse" onclick="setDeviceSelection(this, 'mouse')" />
  <input type="image"  class='DeviceButton' id='TrackPadImage' src="tutorial_images/trackpad.png " alt="Trackpad" onclick="setDeviceSelection(this, 'trackpad')" />
  <input type="image"  class='DeviceButton' id = 'TabletImage' src="tutorial_images/tablet.png " alt="Tablet" onclick="setDeviceSelection(this, 'touchscreen')" />
  <button id='CloseDeviceSelectionButton' onclick="toggleElement(0, 'MechanicalTurkCursorDeviceSelectionScreen'); SESSION['inputDevice'] = (UX.MechanicalTurk_DeviceSelected)" disabled> <i>Make selection...</i> </button>

</div>

<div id="MechanicalTurkHandSelectionScreen">

  <input type="image" class='HandButton' id='LeftHandImage'  style="" id="MouseImage" src="tutorial_images/left_hand.png " alt="Lefthanded" onclick="setHandSelection(this, 'left')" />
  <input type="image"  class='HandButton' id = 'RightHandImage' src="tutorial_images/right_hand.png " alt="Righthanded" onclick="setHandSelection(this, 'right')" />

  <button style="text-align:center; width:100%; height:10%; margin-top:5%; top: 80%; left:35%;"  onclick="toggleElement(0, 'MechanicalTurkHandSelectionScreen'); SESSION['handedness'] = UX.MechanicalTurk_Handedness" id='CloseHandSelectionButton' disabled> <i>Make selection...</i> </button>
</div>

<button id="doneTestingTask" name="doneTestingTask">Done with testing trials</button>

<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script src="setup_upstairs_session.js" type="text/javascript"></script>
<script src="setup_MechanicalTurk_session.js" type="text/javascript"></script>
<script src="mkturk_installsettings.js"></script>
<script src="javascript_utils/seedrandom.js" type="text/javascript"></script>
<script src="mkturk_ImageBuffer.js" type="text/javascript"></script>
<script src="mkturk_bluetooth.js" type="text/javascript"></script>
<script src="mkturk_utils.js" type="text/javascript"></script>
<script src="mkturk_SoundPlayer.js" type="text/javascript"></script>
<script src="mkturk_DiskIO.js" type="text/javascript"></script>
<script src="mkturk_DataWriter.js" type="text/javascript"></script>
<script src="mkturk_UX.js" type="text/javascript"></script>
<script src="mkturk_CheckPointer.js" type="text/javascript"></script>
<script src="mkturk_ActionPoller.js" type="text/javascript"></script>
<script src="mkturk_Reinforcer.js" type="text/javascript"></script>
<script src="mkturk_ScreenDisplayer.js" type="text/javascript"></script>
<script src="mkturk_amazon_utils.js" type="text/javascript"></script>
<script src="mkturk_Verifier.js"></script>
<script src="mkturk_SessionBootStrapper.js" type="text/javascript"></script>
<script src="mkturk_defaultHIT_failsafe.js" type="text/javascript"></script>
<script src="mkturk_screenfunctions.js"></script>
<script src="unit_tests.js"></script>
<script src="mkturk_BiasDetection.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
<script src="ptap_TaskStreamer.js"></script>
<script src="ptap_Playspace.js"></script>
<script src="ptap_HumanEnvironmentInterface.js"></script>
<script src="ptap_spatialunits.js"></script>

<script>

var FLAGS = {}; 


$(async function(){

try{
 
// Load inputs from local storage, web, or Dropbox.
wdm('Running bootstrapper...')
var SBS = new SessionBootStrapper()
var sessionPackage = await SBS.build()
sessionPackage = SBS.verify_session_package(sessionPackage)

console.log('sessionPackage', sessionPackage)

// Construct session
wdm('Setting up session...')

if (sessionPackage['ENVIRONMENT']['rigEnvironment'] == 'mechanicalturk'){
  var freturn = await setup_mechanicalturk_session(sessionPackage)
}
else if (sessionPackage['ENVIRONMENT']['rigEnvironment'] == 'monkeybox'){
  var freturn = await setup_upstairs_session(sessionPackage)
}

// Unpack objects
var DataWriter = freturn['DataWriter']
var HEI = freturn['HEI']
SESSION = freturn['SESSION']


// Main trial loop
console.log('ENTERING MAIN TRIAL STATE MACHINE')
wdm('Entering main trial loop...')


TaskStreamer = new TaskStreamerClass(sessionPackage)
await TaskStreamer.build()
// Attach static data objects 
wdm('Attaching static data probes...')
DataWriter.deposit_key_data('ENVIRONMENT', sessionPackage['ENVIRONMENT'])
DataWriter.deposit_key_data('SESSION', SESSION)
DataWriter.deposit_key_data('BOOTSTRAP_LOG', SBS.get_bootstrap_log())
DataWriter.deposit_key_data('VERIFICATION_LOG', SBS.verification_log)

DataWriter.attach_probe(HEI, 'rewardLog', 'REWARD_LOG')
DataWriter.attach_probe(TaskStreamer, 'behavioral_data', 'BEHAVIOR')
DataWriter.start_polling()

while(TaskStreamer.TERMINAL_STATE == false){
  var stepPackage = await TaskStreamer.get_step()
  var stepOutcome = await HEI.step(stepPackage['frameData'], stepPackage['soundData'], stepPackage['actionRegions'], stepPackage['actionTimeoutMsec'], stepPackage['reward'])

  TaskStreamer.deposit_step_outcome(stepOutcome)
  
}


await DataWriter.conclude_session()  

}// End try



//******* FAILSAFE HANDLING FOR MECHANICAL TURK *******
catch(error){
  console.log('ptap failed with the following error:')
  console.error(error)
  var errorMessage = String(error)
}
finally{
  // Should not get here unless an error took place
  await sleep(1500)

  try{
    var dataobj = DataWriter.package_data()
  }
  catch(error){
    var dataobj = {'ERROR_DataWriter.package_data()':String(error)}
  }
  try{
    var s = JSON.stringify(errorMessage)
    dataobj['ERROR_main_loop'] = s
  }
  catch(error){
    dataobj['ERROR_main_loop_not_found'] = JSON.stringify(String(error))
  }
  dataobj = {'SESSION_DATA':dataobj}
  document.getElementById("submission_data").value = JSON.stringify(dataobj);
  
  // Extract assignmentId from localstorage 
  var landingPageURL = await localStorage.getItem('LANDING_PAGE_URL')
  landingPageURL = atob(landingPageURL)
  var assignmentId = az.get_assignmentId_from_url(landingPageURL)
  document.getElementById("assignmentId").value = assignmentId; 
    
  var submit_url = "https://www.mturk.com/mturk/externalSubmit"
  //var submit_url = "https://workersandbox.mturk.com/mturk/externalSubmit"

  document.getElementById("MechanicalTurk_SubmissionForm").action = submit_url
  console.log('Submitting failed session to mechanical turk')
  
  //document.getElementById("MechanicalTurk_SubmissionForm").submit();
  
  
}

}())



</script>
</body>
</html>
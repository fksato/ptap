<!doctype html>

<head>
<meta name="mobile-web-app-capable" content="yes"> <!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>


<script>
// ******* The experimenter fills out SESSION_PACKAGE ********* 
async function setupSession(){
  try{
    SESSION_PACKAGE = {
  "ENVIRONMENT": {
    "action_event_type": [
      "mouseup", 
      "touchstart", 
      "touchmove"
    ], 
    "bonusUSDPerCorrect": 0.0005, 
    "juiceRewardPer1000Trials": 250, 
    "playspace_degreesVisualAngle": 24, 
    "playspace_verticalOffsetInches": 0, 
    "playspace_viewingDistanceInches": 12, 
    "primary_reinforcer_type": "monetary", 
    "rigEnvironment": "mechanicalturk", 
    "screen_virtualPixelsPerInch": 143.755902965
  }, 
  "GAME_PACKAGE": {
    "GAME": {
      "gameId": "ObjectomeMTS", 
      "maximumTrials": 1000, 
      "minimumTrials": 200, 
      "onFinish": "continue", 
      "periodicRewardAmount": 0, 
      "periodicRewardIntervalMsec": 0, 
      "randomSeed": "none"
    }, 
    "IMAGEBAGS": "https://s3.amazonaws.com/milresources/ImageBagManifests/objectome_imagebags.json", 
    "TASK_SEQUENCE": [
      {
        "actionDiameterDegrees": [
          4, 
          4
        ], 
        "actionXCentroid": [
          0.3, 
          0.7
        ], 
        "actionYCentroid": [
          0.8, 
          0.8
        ], 
        "averageReturnCriterion": 0, 
        "choiceDiameterDegrees": [
          4, 
          4
        ], 
        "choiceMap": {
          "stimulus_objectome_airplane": "token_objectome_airplane", 
          "stimulus_objectome_ant": "token_objectome_ant", 
          "stimulus_objectome_badsuitGuy": "token_objectome_badsuitGuy", 
          "stimulus_objectome_banana": "token_objectome_banana", 
          "stimulus_objectome_bear": "token_objectome_bear", 
          "stimulus_objectome_bird": "token_objectome_bird", 
          "stimulus_objectome_boat": "token_objectome_boat", 
          "stimulus_objectome_book": "token_objectome_book", 
          "stimulus_objectome_bowl": "token_objectome_bowl", 
          "stimulus_objectome_calculator": "token_objectome_calculator", 
          "stimulus_objectome_camel": "token_objectome_camel", 
          "stimulus_objectome_camera": "token_objectome_camera", 
          "stimulus_objectome_car": "token_objectome_car", 
          "stimulus_objectome_cat": "token_objectome_cat", 
          "stimulus_objectome_chair": "token_objectome_chair", 
          "stimulus_objectome_clock": "token_objectome_clock", 
          "stimulus_objectome_dog": "token_objectome_dog", 
          "stimulus_objectome_dress": "token_objectome_dress", 
          "stimulus_objectome_drum": "token_objectome_drum", 
          "stimulus_objectome_duck": "token_objectome_duck", 
          "stimulus_objectome_elephant": "token_objectome_elephant", 
          "stimulus_objectome_fish": "token_objectome_fish", 
          "stimulus_objectome_flute": "token_objectome_flute", 
          "stimulus_objectome_fork": "token_objectome_fork", 
          "stimulus_objectome_frog": "token_objectome_frog", 
          "stimulus_objectome_guitar": "token_objectome_guitar", 
          "stimulus_objectome_gun": "token_objectome_gun", 
          "stimulus_objectome_hamburger": "token_objectome_hamburger", 
          "stimulus_objectome_hammer": "token_objectome_hammer", 
          "stimulus_objectome_hanger": "token_objectome_hanger", 
          "stimulus_objectome_head": "token_objectome_head", 
          "stimulus_objectome_helicopter": "token_objectome_helicopter", 
          "stimulus_objectome_horse": "token_objectome_horse", 
          "stimulus_objectome_house": "token_objectome_house", 
          "stimulus_objectome_knife": "token_objectome_knife", 
          "stimulus_objectome_lamp": "token_objectome_lamp", 
          "stimulus_objectome_laptop": "token_objectome_laptop", 
          "stimulus_objectome_leg": "token_objectome_leg", 
          "stimulus_objectome_mirror": "token_objectome_mirror", 
          "stimulus_objectome_nail": "token_objectome_nail", 
          "stimulus_objectome_necklace": "token_objectome_necklace", 
          "stimulus_objectome_pants": "token_objectome_pants", 
          "stimulus_objectome_pear": "token_objectome_pear", 
          "stimulus_objectome_pen": "token_objectome_pen", 
          "stimulus_objectome_piano": "token_objectome_piano", 
          "stimulus_objectome_pig": "token_objectome_pig", 
          "stimulus_objectome_pineapple": "token_objectome_pineapple", 
          "stimulus_objectome_pumpkin": "token_objectome_pumpkin", 
          "stimulus_objectome_rhino": "token_objectome_rhino", 
          "stimulus_objectome_shirt": "token_objectome_shirt", 
          "stimulus_objectome_shoe": "token_objectome_shoe", 
          "stimulus_objectome_shorts": "token_objectome_shorts", 
          "stimulus_objectome_skirt": "token_objectome_skirt", 
          "stimulus_objectome_spatula": "token_objectome_spatula", 
          "stimulus_objectome_spider": "token_objectome_spider", 
          "stimulus_objectome_spoon": "token_objectome_spoon", 
          "stimulus_objectome_syringe": "token_objectome_syringe", 
          "stimulus_objectome_table": "token_objectome_table", 
          "stimulus_objectome_tank": "token_objectome_tank", 
          "stimulus_objectome_tie": "token_objectome_tie", 
          "stimulus_objectome_tiger": "token_objectome_tiger", 
          "stimulus_objectome_tire": "token_objectome_tire", 
          "stimulus_objectome_toaster": "token_objectome_toaster", 
          "stimulus_objectome_train": "token_objectome_train", 
          "stimulus_objectome_tree": "token_objectome_tree", 
          "stimulus_objectome_truck": "token_objectome_truck", 
          "stimulus_objectome_turtle": "token_objectome_turtle", 
          "stimulus_objectome_watch": "token_objectome_watch", 
          "stimulus_objectome_whitecoatDoctor": "token_objectome_whitecoatDoctor", 
          "stimulus_objectome_whitecoatNurse": "token_objectome_whitecoatNurse", 
          "stimulus_objectome_wrench": "token_objectome_wrench", 
          "stimulus_objectome_zebra": "token_objectome_zebra"
        }, 
        "choiceTimeLimitMsec": 5000, 
        "choiceXCentroid": [
          0.3, 
          0.7
        ], 
        "choiceYCentroid": [
          0.8, 
          0.8
        ], 
        "fixationDiameterDegrees": 4, 
        "fixationXCentroid": 0.5, 
        "fixationYCentroid": 0.8, 
        "minTrialsCriterion": 200, 
        "probabilityRepeatWhenWrong": 0, 
        "punishStreakTimeOutMultiplier": 1.5, 
        "punishTimeOutMsec": 2000, 
        "rewardTimeOutMsec": 100, 
        "sampleBagNames": [
          "stimulus_objectome_flute", 
          "stimulus_objectome_pineapple", 
          "stimulus_objectome_syringe", 
          "stimulus_objectome_house", 
          "stimulus_objectome_dress", 
          "stimulus_objectome_lamp", 
          "stimulus_objectome_whitecoatDoctor", 
          "stimulus_objectome_clock", 
          "stimulus_objectome_car", 
          "stimulus_objectome_cat", 
          "stimulus_objectome_watch", 
          "stimulus_objectome_shoe", 
          "stimulus_objectome_tank", 
          "stimulus_objectome_laptop", 
          "stimulus_objectome_tire", 
          "stimulus_objectome_banana", 
          "stimulus_objectome_skirt", 
          "stimulus_objectome_book", 
          "stimulus_objectome_helicopter", 
          "stimulus_objectome_tie", 
          "stimulus_objectome_camel", 
          "stimulus_objectome_knife", 
          "stimulus_objectome_shirt", 
          "stimulus_objectome_hanger", 
          "stimulus_objectome_piano", 
          "stimulus_objectome_pig", 
          "stimulus_objectome_necklace", 
          "stimulus_objectome_spider", 
          "stimulus_objectome_calculator", 
          "stimulus_objectome_leg", 
          "stimulus_objectome_zebra", 
          "stimulus_objectome_chair", 
          "stimulus_objectome_tree", 
          "stimulus_objectome_bear", 
          "stimulus_objectome_spoon", 
          "stimulus_objectome_head", 
          "stimulus_objectome_pear", 
          "stimulus_objectome_bird", 
          "stimulus_objectome_hamburger", 
          "stimulus_objectome_badsuitGuy", 
          "stimulus_objectome_elephant", 
          "stimulus_objectome_boat", 
          "stimulus_objectome_hammer", 
          "stimulus_objectome_tiger", 
          "stimulus_objectome_toaster", 
          "stimulus_objectome_wrench", 
          "stimulus_objectome_camera", 
          "stimulus_objectome_airplane", 
          "stimulus_objectome_spatula", 
          "stimulus_objectome_horse", 
          "stimulus_objectome_bowl", 
          "stimulus_objectome_shorts", 
          "stimulus_objectome_rhino", 
          "stimulus_objectome_nail", 
          "stimulus_objectome_pen", 
          "stimulus_objectome_pants", 
          "stimulus_objectome_pumpkin", 
          "stimulus_objectome_fork", 
          "stimulus_objectome_duck", 
          "stimulus_objectome_drum", 
          "stimulus_objectome_gun", 
          "stimulus_objectome_train", 
          "stimulus_objectome_guitar", 
          "stimulus_objectome_frog", 
          "stimulus_objectome_dog", 
          "stimulus_objectome_truck", 
          "stimulus_objectome_table", 
          "stimulus_objectome_fish", 
          "stimulus_objectome_mirror", 
          "stimulus_objectome_whitecoatNurse", 
          "stimulus_objectome_ant", 
          "stimulus_objectome_turtle"
        ], 
        "sampleDiameterDegrees": 8, 
        "sampleOffMsec": 0, 
        "sampleOnMsec": 150, 
        "sampleSampleWithReplacement": true, 
        "sampleXCentroid": 0.5, 
        "sampleYCentroid": 0.5, 
        "taskType": "MTS"
      }
    ]
  }
}
  }
  catch(error){
    console.log(error)
    SESSION_PACKAGE = undefined
  }

  try{
    // Not necessary to fill out for mechanical turk; in that case the workerId is extracted from the URL suffix. 
    // Fill in for upstairs task; e.g. 'Zico'
    agentId = __AGENTID_GOES_HERE__
  }
  catch(error){
    console.log(error)
    agentId = 'unknown_agent_'+Math.round(window.performance.timing.navigationStart)
    agentId = 'unknown_agent_ip_'
    agentId+=await get_ip_address()
  }

  var localSavePackage = {'SESSION_PACKAGE':SESSION_PACKAGE, 'agentId':agentId, 'LANDING_PAGE_URL':window.location.href}
  await concludeLandingPage(localSavePackage)
}

</script>

<script>
// ******** Util functions ********
async function concludeLandingPage(localSavePackage){
    
    SESSION_PACKAGE = localSavePackage['SESSION_PACKAGE']
    agentId = localSavePackage['agentId']
    LANDING_PAGE_URL = localSavePackage['LANDING_PAGE_URL']

    console.log('landing page url', window.location.href)

    await localStorage.setItem("SESSION_PACKAGE", btoa(JSON.stringify(SESSION_PACKAGE)))
    await localStorage.setItem('LANDING_PAGE_URL', btoa(LANDING_PAGE_URL))
    await localStorage.setItem('agentId', btoa(agentId))

    console.log('All items stored. Redirecting...')
    await new Promise(resolve => setTimeout(resolve, 1000));
    go_to_main_page()
}

function go_to_main_page(){
  var currentURL = window.location.href 
    if(currentURL.indexOf('localhost')!=-1){
        window.location.href = '/public/mkturk.html?loadtime=' +Math.round(window.performance.timing.navigationStart)
    }
    else{
      try{
        s3_bucket = "ptapmechanicalturk"
        window.location.href = "https://s3.amazonaws.com/"+s3_bucket+"/public/mkturk.html?loadtime="+Math.round(window.performance.timing.navigationStart)
      }
      catch(error){
        window.location.href = "https://s3.amazonaws.com/ptapscratch/public/mkturk.html?loadtime="+Math.round(window.performance.timing.navigationStart)
      }
        
    }

    
}

async function get_ip_address(){
      // need to do here or can do in main?

      var resolveFunc
      var rejectFunc
      var p = new Promise(function(resolve, reject){
          resolveFunc = resolve
          rejectFunc = reject
      })

      var xhttp = new XMLHttpRequest(); 


      try{
          xhttp.onreadystatechange = function(){
              if (this.readyState == 4 && this.status == 200){
                  resolveFunc(this.responseText)
              }
          }
      }
      catch(error){
          console.log(error)
      }
      
      xhttp.open("GET", "https://api.ipify.org?format=json", true);

      xhttp.send();
      var s = await p
      s = JSON.parse(s)

      return s['ip']       
}

</script>


<script>
(async function(){
    await setupSession();
}
)()
</script>

</head>

<body>
    Loading HIT...
</body>
</html>
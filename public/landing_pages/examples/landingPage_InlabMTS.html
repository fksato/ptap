<!doctype html>

<head>
<meta name="mobile-web-app-capable" content="yes"> <!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>


<script>
// ******* The experimenter fills out SESSION_PACKAGE ********* 
async function setupSession(){
  try{
    SESSION_PACKAGE = {
    "ENVIRONMENT": {
        "action_event_type": [
            "mouseup", 
            "touchstart", 
            "touchmove"
        ], 
        "playspace_degreesVisualAngle": 30, 
        "playspace_verticalOffsetInches": 0, 
        "playspace_viewingDistanceInches": 8, 
        "primary_reinforcer_type": "juice", 
        "rigEnvironment": "monkeybox", 
        "screen_virtualPixelsPerInch": 143.755902965
    }, 
    "GAME_PACKAGE": {
        "GAME": {
            "bonusUSDPerCorrect": 0, 
            "gameID": "example_inlab_MTS", 
            "onFinish": "continue", 
            "periodicRewardAmount": 1, 
            "periodicRewardIntervalMsec": 60000, 
            "randomSeed": "none"
        }, 
        "IMAGEBAGS": "https://s3.amazonaws.com/milresources/ImageBagMetaDefinitions/MutatorTraining_FullVarWithBGSetA.json", 
        "TASK_SEQUENCE": [
            {
                "actionDiameterDegrees": [
                    6, 
                    6
                ], 
                "actionXCentroid": [
                    0.2, 
                    0.8
                ], 
                "actionYCentroid": [
                    0.8, 
                    0.8
                ], 
                "averageReturnCriterion": 0.8, 
                "choiceDiameterDegrees": [
                    6, 
                    6
                ], 
                "choiceMap": {
                    "FullVarWithBGSetA_batch0obj0": "FullVarWithBGSetA_batch0obj0", 
                    "FullVarWithBGSetA_batch0obj1": "FullVarWithBGSetA_batch0obj1", 
                    "FullVarWithBGSetA_batch0obj2": "FullVarWithBGSetA_batch0obj2"
                }, 
                "choiceTimeLimitMsec": 5000, 
                "choiceXCentroid": [
                    0.2, 
                    0.8
                ], 
                "choiceYCentroid": [
                    0.8, 
                    0.8
                ], 
                "fixationDiameterDegrees": 3, 
                "fixationXCentroid": 0.5, 
                "fixationYCentroid": 0.8, 
                "minTrialsCriterion": 5, 
                "probabilityRepeatWhenWrong": 0, 
                "punishStreakTimeOutMultiplier": 1, 
                "punishTimeOutMsec": 100, 
                "rewardTimeOutMsec": 150, 
                "sampleBagNames": [
                    "FullVarWithBGSetA_batch0obj0", 
                    "FullVarWithBGSetA_batch0obj1", 
                    "FullVarWithBGSetA_batch0obj2"
                ], 
                "sampleDiameterDegrees": 8, 
                "sampleOffMsec": 0, 
                "sampleOnMsec": 200, 
                "sampleSampleWithReplacement": true, 
                "sampleXCentroid": 0.5, 
                "sampleYCentroid": 0.5, 
                "taskType": "MTS"
            }
        ]
    }
}
  }
  catch(error){
    console.log(error)
    SESSION_PACKAGE = undefined
  }

  try{
    // Not necessary to fill out for mechanical turk; in that case the workerId is extracted from the URL suffix. 
    // Fill in for upstairs task; e.g. 'Zico'
    agentID = "example_inlab_worker"
  }
  catch(error){
    console.log(error)
    agentID = 'unknown_agent_'+Math.round(window.performance.timing.navigationStart)
    agentID = 'unknown_agent_ip_'
    agentID+=await get_ip_address()
  }

  var localSavePackage = {'SESSION_PACKAGE':SESSION_PACKAGE, 'agentID':agentID, 'LANDING_PAGE_URL':window.location.href}
  await concludeLandingPage(localSavePackage)
}

</script>

<script>
// ******** Util functions ********
async function concludeLandingPage(localSavePackage){
    
    SESSION_PACKAGE = localSavePackage['SESSION_PACKAGE']
    agentID = localSavePackage['agentID']
    LANDING_PAGE_URL = localSavePackage['LANDING_PAGE_URL']

    console.log('landing page url', window.location.href)

    await localStorage.setItem("SESSION_PACKAGE", btoa(JSON.stringify(SESSION_PACKAGE)))
    await localStorage.setItem('LANDING_PAGE_URL', btoa(LANDING_PAGE_URL))
    await localStorage.setItem('agentID', btoa(agentID))

    console.log('All items stored. Redirecting...')
    await new Promise(resolve => setTimeout(resolve, 1000));
    go_to_main_page()
}

function go_to_main_page(){
  var currentURL = window.location.href 
    if(currentURL.indexOf('localhost')!=-1){
        window.location.href = '/public/mkturk.html?loadtime=' +Math.round(window.performance.timing.navigationStart)
    }
    else{
        window.location.href = "https://s3.amazonaws.com/ptapscratch/public/mkturk.html?loadtime="+Math.round(window.performance.timing.navigationStart)
    }
}

async function get_ip_address(){
      // need to do here or can do in main?

      var resolveFunc
      var rejectFunc
      var p = new Promise(function(resolve, reject){
          resolveFunc = resolve
          rejectFunc = reject
      })

      var xhttp = new XMLHttpRequest(); 


      try{
          xhttp.onreadystatechange = function(){
              if (this.readyState == 4 && this.status == 200){
                  resolveFunc(this.responseText)
              }
          }
      }
      catch(error){
          console.log(error)
      }
      
      xhttp.open("GET", "https://api.ipify.org?format=json", true);

      xhttp.send();
      var s = await p
      s = JSON.parse(s)

      return s['ip']       
}

</script>


<script>
(async function(){
    await setupSession();
}
)()
</script>

</head>

<body>
    Loading HIT...
</body>
</html>